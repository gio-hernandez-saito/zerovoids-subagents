#!/usr/bin/env bash
# zerovoids-subagents setup script
# Links agents to a project's .claude directory

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
AGENTS_DIR="$REPO_ROOT/agents"

# Function to print colored output
print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_info() { echo -e "${YELLOW}ℹ${NC} $1"; }

# Function to show usage
usage() {
    cat << EOF
Usage: $(basename "$0") [TARGET_DIR] [OPTIONS]

Setup zerovoids-subagents for a project or globally.

Arguments:
    TARGET_DIR          Project directory (default: current directory)

Options:
    --global, -g        Install globally to ~/.claude/agents
    --profile PROFILE   Use a specific profile (default: none)
    --help, -h         Show this help message

Examples:
    $(basename "$0")                          # Setup in current directory
    $(basename "$0") ~/my-project            # Setup in specific project
    $(basename "$0") --global                # Setup globally
    $(basename "$0") ~/project --profile frontend-full

EOF
    exit 0
}

# Function to setup agents
setup_agents() {
    local target_dir="$1"
    local profile="$2"
    
    # Create .claude directory if it doesn't exist
    mkdir -p "$target_dir/.claude"
    
    # Remove existing agents link/directory if it exists
    if [ -L "$target_dir/.claude/agents" ]; then
        rm "$target_dir/.claude/agents"
        print_info "Removed existing agents symlink"
    elif [ -d "$target_dir/.claude/agents" ]; then
        print_error "Directory .claude/agents already exists (not a symlink)"
        print_info "Please remove it manually or backup if needed"
        exit 1
    fi
    
    # Create symlink
    ln -sf "$AGENTS_DIR" "$target_dir/.claude/agents"
    
    print_success "Linked agents to $target_dir/.claude/agents"
    
    # Apply profile if specified
    if [ -n "$profile" ]; then
        local profile_file="$REPO_ROOT/profiles/${profile}.json"
        if [ -f "$profile_file" ]; then
            cp "$profile_file" "$target_dir/.claude/profile.json"
            print_success "Applied profile: $profile"
        else
            print_error "Profile not found: $profile"
            exit 1
        fi
    fi
}

# Parse arguments
TARGET_DIR="."
GLOBAL=false
PROFILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --global|-g)
            GLOBAL=true
            shift
            ;;
        --profile)
            PROFILE="$2"
            shift 2
            ;;
        --help|-h)
            usage
            ;;
        *)
            TARGET_DIR="$1"
            shift
            ;;
    esac
done

# Main execution
if [ "$GLOBAL" = true ]; then
    print_info "Setting up globally..."
    setup_agents "$HOME" "$PROFILE"
    print_success "Global setup complete!"
    print_info "Agents available in all projects"
else
    # Resolve target directory
    TARGET_DIR="$(cd "$TARGET_DIR" 2>/dev/null && pwd || echo "$TARGET_DIR")"
    
    if [ ! -d "$TARGET_DIR" ]; then
        print_error "Directory does not exist: $TARGET_DIR"
        exit 1
    fi
    
    print_info "Setting up in: $TARGET_DIR"
    setup_agents "$TARGET_DIR" "$PROFILE"
    print_success "Setup complete!"
    print_info "Run 'claude --help' in your project to get started"
fi

# Show next steps
echo ""
print_info "Next steps:"
echo "  1. cd $TARGET_DIR"
echo "  2. claude 'your task here'"
echo "  3. Agents will be used automatically when appropriate"
echo ""
print_info "Available agents: $(ls -1 "$AGENTS_DIR"/core/*.md "$AGENTS_DIR"/specialized/*.md 2>/dev/null | wc -l)"
