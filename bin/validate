#!/usr/bin/env bash
# Validate agent files and documentation format

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(dirname "$SCRIPT_DIR")"
AGENTS_DIR="$REPO_ROOT/agents"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_success() { echo -e "${GREEN}✓${NC} $1"; }
print_error() { echo -e "${RED}✗${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }

ERRORS=0
WARNINGS=0

# Validate a single agent file
validate_agent() {
    local file="$1"
    local filename=$(basename "$file")
    
    echo "Validating: $filename"
    
    # Check if file starts with frontmatter
    if ! head -n1 "$file" | grep -q "^---$"; then
        print_error "Missing frontmatter opening"
        ((ERRORS++))
        return
    fi
    
    # Extract frontmatter (between first and second ---)
    local frontmatter=$(awk '/^---$/{flag++; next} flag==1' "$file" | awk '/^---$/{exit} {print}')
    
    # Required fields
    local required_fields=("name" "description" "created")
    for field in "${required_fields[@]}"; do
        if ! echo "$frontmatter" | grep -q "^${field}:"; then
            print_error "Missing required field: $field"
            ((ERRORS++))
        fi
    done
    
    # Check name format (lowercase, hyphens only)
    local name=$(echo "$frontmatter" | grep "^name:" | cut -d: -f2- | xargs)
    if [ -n "$name" ]; then
        if ! echo "$name" | grep -qE "^[a-z0-9-]+$"; then
            print_error "Invalid name format: $name (use lowercase and hyphens only)"
            ((ERRORS++))
        fi
        
        # Check if filename matches name
        local expected_filename="${name}.md"
        if [ "$filename" != "$expected_filename" ] && [ "$filename" != "_template.md" ]; then
            print_warning "Filename doesn't match name: expected $expected_filename"
            ((WARNINGS++))
        fi
    fi
    
    # Check description length
    local description=$(echo "$frontmatter" | grep "^description:" | cut -d: -f2- | xargs)
    if [ -n "$description" ]; then
        local desc_length=${#description}
        if [ $desc_length -lt 20 ]; then
            print_warning "Description too short ($desc_length chars, recommend 20+)"
            ((WARNINGS++))
        fi
    fi
    
    # Check if content exists after frontmatter
    local content_lines=$(awk 'BEGIN{flag=0} /^---$/{flag++; next} flag>=2{print}' "$file" | grep -c "." || true)
    if [ $content_lines -lt 5 ]; then
        print_warning "Agent content seems too short ($content_lines lines)"
        ((WARNINGS++))
    fi
    
    if [ $ERRORS -eq 0 ]; then
        print_success "Valid"
    fi
    
    echo ""
}

# Validate markdown date format
validate_md_dates() {
    local file="$1"
    local filename=$(basename "$file")
    
    echo "Validating dates: $filename"
    
    local date_errors=0
    
    # Check Last Updated format if exists
    if grep -q "Last Updated" "$file"; then
        if ! grep -q "^\*\*Last Updated\*\*: [0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}$" "$file"; then
            print_error "Invalid Last Updated format"
            print_warning "Expected format: **Last Updated**: YYYY-MM-DD"
            ((ERRORS++))
            date_errors=1
        fi
    fi
    
    if [ $date_errors -eq 0 ]; then
        print_success "Valid"
    fi
    
    echo ""
}

# Main validation
echo "=== Validating zerovoids-subagents ==="
echo ""

echo "--- Agent Files ---"
# Find all agent files (excluding template)
while IFS= read -r -d '' file; do
    if [ "$(basename "$file")" != "_template.md" ]; then
        validate_agent "$file"
    fi
done < <(find "$AGENTS_DIR" -name "*.md" -type f -print0)

echo "--- Documentation Files ---"
# Validate documentation markdown files
for file in "$REPO_ROOT/README.md" "$REPO_ROOT/CONTRIBUTING.md" "$REPO_ROOT"/docs/*.md; do
    if [ -f "$file" ]; then
        validate_md_dates "$file"
    fi
done

# Summary
echo "=== Validation Summary ==="
if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    print_success "All files valid!"
    exit 0
elif [ $ERRORS -eq 0 ]; then
    print_warning "$WARNINGS warning(s)"
    exit 0
else
    print_error "$ERRORS error(s), $WARNINGS warning(s)"
    exit 1
fi
