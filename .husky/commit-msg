#!/bin/bash
# Commit message validation hook
# Enforces zerovoids-subagents commit message format

set -e

# Allowed prefixes
ALLOWED_PREFIXES="feat|fix|chore|docs|refactor|revert"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_error() { echo -e "${RED}❌${NC} $1"; }
print_success() { echo -e "${GREEN}✅${NC} $1"; }
print_info() { echo -e "${YELLOW}ℹ${NC} $1"; }

# Read commit message
commit_msg_file="$1"

# Read file line by line, preserving empty lines
mapfile -t lines < "$commit_msg_file"

# Check if message is empty
if [ ${#lines[@]} -eq 0 ] || [ -z "${lines[0]}" ]; then
    print_error "커밋 메시지가 비어있습니다"
    exit 1
fi

# 1. Validate first line: prefix: title
first_line="${lines[0]}"
if ! echo "$first_line" | grep -qE "^($ALLOWED_PREFIXES): .+"; then
    print_error "첫 줄 형식 오류"
    echo ""
    print_info "올바른 형식:"
    echo "  [prefix]: [제목]"
    echo ""
    print_info "허용된 prefix:"
    echo "  feat, fix, chore, docs, refactor, revert"
    echo ""
    print_info "예시:"
    echo "  feat: add react-optimizer agent"
    echo "  fix: correct template frontmatter"
    echo "  docs: update architecture guide"
    exit 1
fi

# 2. Check second line is empty (if exists)
if [ ${#lines[@]} -gt 1 ]; then
    second_line="${lines[1]}"
    if [ -n "$second_line" ]; then
        print_error "두 번째 줄은 비어있어야 합니다"
        echo ""
        print_info "올바른 형식:"
        echo "  prefix: 제목"
        echo "  (빈 줄)"
        echo "  - 내용 1"
        echo "  - 내용 2"
        exit 1
    fi
fi

# 3. Check body lines start with '- ' (dash + space)
if [ ${#lines[@]} -gt 2 ]; then
    for ((i=2; i<${#lines[@]}; i++)); do
        line="${lines[$i]}"
        # Skip empty lines
        if [ -n "$line" ]; then
            if ! echo "$line" | grep -qE "^- "; then
                print_error "본문은 '- '로 시작해야 합니다 (대시 + 띄어쓰기)"
                echo ""
                print_info "문제 라인:"
                echo "  $line"
                echo ""
                print_info "올바른 형식:"
                echo "  - 내용을 여기에 작성"
                exit 1
            fi
        fi
    done
fi

print_success "커밋 메시지 형식 올바름"
exit 0
